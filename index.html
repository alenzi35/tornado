<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

html, body {
    margin: 0;
    padding: 0;
    background: black;
    color: white;
    font-family: Arial, sans-serif;
}

#map {
    width: 100vw;
    height: 100vh;
}

#validTimeBox {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
    z-index: 1000;
}

</style>
</head>

<body>

<div id="map"></div>

<div id="validTimeBox">
<span id="validTime">Loading...</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/proj4"></script>
<script src="https://unpkg.com/proj4leaflet"></script>

<script>

// ---------------- MAP INIT ----------------

const map = L.map('map', {
    zoomControl: false,
    attributionControl: false
}).setView([39, -96], 5);


// ---------------- COLOR FUNCTION ----------------
// 0% = blue
// 1% = red
// smooth gradient

function getColor(prob) {

    const t = Math.max(0, Math.min(prob, 0.01)) / 0.01;

    const r = Math.round(255 * t);
    const g = 0;
    const b = Math.round(255 * (1 - t));

    return `rgb(${r},${g},${b})`;
}


// ---------------- LOAD STATE BORDERS ----------------

fetch("map/data/states.geojson")
.then(response => response.json())
.then(data => {

    L.geoJSON(data, {

        style: {
            color: "#FFFFFF",
            weight: 0.5,
            fill: false
        }

    }).addTo(map);

});


// ---------------- LOAD RAP CELLS ----------------

fetch("map/data/tornado_prob_lcc.json")
.then(response => response.json())
.then(data => {

    const proj = data.projection;

    const crs = new L.Proj.CRS(
        "RAP_LCC",
        `+proj=lcc +lat_1=${proj.lat_1} +lat_2=${proj.lat_2} +lat_0=${proj.lat_0} +lon_0=${proj.lon_0} +a=${proj.a} +b=${proj.b} +units=m +no_defs`
    );

    data.features.forEach(cell => {

        const sw = crs.unproject(L.point(cell.x, cell.y));
        const ne = crs.unproject(L.point(cell.x + cell.dx, cell.y + cell.dy));

        L.rectangle([sw, ne], {

            fillColor: getColor(cell.prob),
            fillOpacity: 0.65,
            stroke: false

        }).addTo(map);

    });

});


// ---------------- LOAD VALID TIME ----------------

fetch("map/data/tornado_prob_lcc.json")
.then(response => response.json())
.then(meta => {

    document.getElementById("validTime").innerText =
        meta.valid.replace(" UTC", "") + " UTC";

});

</script>

</body>
</html>
