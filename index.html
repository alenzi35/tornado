<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tornado Map</title>

<style>
body { margin:0; background:#111; overflow:hidden; }
canvas { display:block; }
</style>
</head>

<body>

<canvas id="mapCanvas"></canvas>

<script>

const canvas = document.getElementById("mapCanvas");
const ctx = canvas.getContext("2d");

let scale=1, offsetX=0, offsetY=0;
let cells=[], borders=[];

function resize(){
 canvas.width=window.innerWidth;
 canvas.height=window.innerHeight;
 draw();
}
window.addEventListener("resize", resize);
resize();


fetch("map/data/borders_lcc.json")
.then(r=>r.json())
.then(d=>{
 borders=d.features;
 draw();
});


fetch("map/data/tornado_prob_lcc_masked.json")
.then(r=>r.json())
.then(d=>{
 cells=d.features;
 fit();
 draw();
});


function fit(){

 let minX=1e30,maxX=-1e30,minY=1e30,maxY=-1e30;

 cells.forEach(c=>{
  minX=Math.min(minX,c.x);
  maxX=Math.max(maxX,c.x+c.dx);
  minY=Math.min(minY,c.y);
  maxY=Math.max(maxY,c.y+c.dy);
 });

 let w=maxX-minX;
 let h=maxY-minY;

 scale=Math.min(canvas.width/w, canvas.height/h)*0.95;

 offsetX=canvas.width/2-(minX+w/2)*scale;
 offsetY=canvas.height/2+(minY+h/2)*scale;
}


function color(p){

 let r=Math.floor(p*255);
 let b=Math.floor((1-p)*255);

 return `rgba(${r},0,${b},0.8)`;
}


function draw(){

 ctx.setTransform(1,0,0,1,0,0);
 ctx.clearRect(0,0,canvas.width,canvas.height);

 ctx.setTransform(scale,0,0,-scale,offsetX,offsetY);

 cells.forEach(c=>{

  if(c.dallas){

   ctx.fillStyle="yellow";

  }else{

   ctx.fillStyle=color(c.prob);

  }

  ctx.fillRect(c.x,c.y,c.dx,c.dy);

 });

 ctx.strokeStyle="white";
 ctx.lineWidth=1/scale;

 ctx.beginPath();

 borders.forEach(line=>{
  line.forEach((p,i)=>{
   if(i==0)ctx.moveTo(p[0],p[1]);
   else ctx.lineTo(p[0],p[1]);
  });
 });

 ctx.stroke();
}

</script>

</body>
</html>
