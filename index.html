<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>RAP Tornado Probability</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body {
    margin: 0;
    padding: 0;
}

#map {
    width: 100vw;
    height: 100vh;
}

.valid-time-box {
    position: absolute;
    top: 10px;
    left: 50px;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 6px 10px;
    font-family: monospace;
    font-size: 14px;
    border-radius: 4px;
    z-index: 1000;
}
</style>

</head>
<body>

<div id="map"></div>
<div class="valid-time-box" id="validTime">Loading...</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- REQUIRED for proper polygon clipping -->
<script src="https://unpkg.com/leaflet-pip@1.1.0/leaflet-pip.min.js"></script>

<script>

// ---------------- MAP SETUP ----------------

const map = L.map('map', {
    zoomControl: false,
    attributionControl: false
}).setView([39, -96], 5);


// ---------------- COLOR GRADIENT ----------------
// 0% = blue
// 1% = red
// smooth gradient

function getColor(prob) {

    const p = Math.max(0, Math.min(prob, 0.01));

    const t = p / 0.01;

    const r = Math.round(255 * t);
    const g = 0;
    const b = Math.round(255 * (1 - t));

    return `rgb(${r},${g},${b})`;
}


// ---------------- LOAD CONUS OUTLINE ----------------

let conusLayer;

fetch("conus.geojson")
.then(res => res.json())
.then(data => {

    conusLayer = L.geoJSON(data, {

        style: {
            color: "#FFFFFF",
            weight: 1,
            fill: false
        }

    }).addTo(map);

    loadCells();
});


// ---------------- LOAD STATE BORDERS ----------------

fetch("states.geojson")
.then(res => res.json())
.then(data => {

    L.geoJSON(data, {

        style: {
            color: "#FFFFFF",
            weight: 0.5,
            fill: false
        }

    }).addTo(map);

});


// ---------------- CONUS CELL CHECK ----------------

function isCellInCONUS(bounds) {

    const corners = [

        [bounds.getSouth(), bounds.getWest()],
        [bounds.getSouth(), bounds.getEast()],
        [bounds.getNorth(), bounds.getWest()],
        [bounds.getNorth(), bounds.getEast()]

    ];

    for (const corner of corners) {

        if (leafletPip.pointInLayer(corner, conusLayer).length > 0) {
            return true;
        }

    }

    return false;
}


// ---------------- LOAD CELLS ----------------

function loadCells() {

    fetch("rap_cells.json")
    .then(res => res.json())
    .then(cells => {

        cells.forEach(cell => {

            const bounds = L.latLngBounds(

                [cell.lat_min, cell.lon_min],
                [cell.lat_max, cell.lon_max]

            );

            // STRICT CONUS CLIP
            if (!isCellInCONUS(bounds)) return;

            L.rectangle(bounds, {

                fillColor: getColor(cell.prob),
                fillOpacity: 0.6,
                stroke: false

            }).addTo(map);

        });

    });

}


// ---------------- VALID TIME FIX ----------------

fetch("rap_metadata.json")
.then(res => res.json())
.then(meta => {

    const start = meta.valid_start; // example: 18:00
    const end = meta.valid_end;     // example: 19:00

    document.getElementById("validTime").innerText =
        `${start}-${end} UTC`;

});

</script>

</body>
</html>
